from flask import Flask, request, jsonify
from flask_cors import CORS
# üëá Import Library ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
from pythainlp import word_tokenize
from pythainlp.corpus import thai_stopwords

app = Flask(__name__)
CORS(app)

# ==========================================
# üõ†Ô∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏ó‡∏¥‡πâ‡∏á (Stop Words)
# ==========================================
additional_stop_words = [
    '‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', '‡∏£‡∏π‡πâ', '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à', '‡∏ù‡∏∂‡∏Å', '‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥', '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', '‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢', 
    '‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå', '‡πÉ‡∏ä‡πâ', '‡πÄ‡∏ô‡πâ‡∏ô', '‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°', '‡πÅ‡∏•‡∏∞', '‡∏´‡∏£‡∏∑‡∏≠', 
    '‡∏Å‡∏±‡∏ö', '‡πÇ‡∏î‡∏¢', '‡∏ú‡πà‡∏≤‡∏ô', '‡∏ï‡∏≤‡∏°', '‡∏à‡∏≤‡∏Å', '‡∏ï‡πà‡∏≤‡∏á‡πÜ', '‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô', 
    '‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô', '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£', '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', '‡∏ó‡∏±‡∏Å‡∏©‡∏∞', '‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£'
]

# ‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡∏´‡∏¢‡∏∏‡∏î‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô + ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏á
# ‡πÉ‡∏ä‡πâ set() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
ALL_STOP_WORDS = set(thai_stopwords()).union(
    set(['‡∏Å‡∏≤‡∏£', '‡∏Ñ‡∏ß‡∏≤‡∏°', '‡∏®‡∏∂‡∏Å‡∏©‡∏≤', '‡πÄ‡∏û‡∏∑‡πà‡∏≠', '‡πÉ‡∏ô', '‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤'] + additional_stop_words)
)

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
def clean_text(text):
    if not text: 
        return ""
    
    # 1. ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥ (Tokenize)
    words = word_tokenize(text, engine='newmm')
    
    # 2. ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏î‡∏µ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Stop word ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á)
    useful_words = [w for w in words if w not in ALL_STOP_WORDS and w.strip()]
    
    # 3. ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô list ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏´‡∏•‡∏±‡∏Å
    return useful_words

# ==========================================
# üöÄ API Endpoint
# ==========================================
@app.route('/api/predict', methods=['POST'])
def predict():
    try:
        data = request.json
        print(f"üì• Raw Data: {data}")
        
        # ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà User ‡∏Å‡∏£‡∏≠‡∏Å‡∏°‡∏≤
        full_text = f"{data.get('like', '')} {data.get('skill', '')} {data.get('hobby', '')} {data.get('dream', '')}"
        
        # ‚ú® ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ü‡∏∏‡πà‡∏°‡πÄ‡∏ü‡∏∑‡∏≠‡∏¢
        keywords = clean_text(full_text)
        print(f"‚ú® Cleaned Keywords: {keywords}") 
        # ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏ñ‡πâ‡∏≤ User ‡∏û‡∏¥‡∏°‡∏û‡πå "‡∏ä‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô" -> ‡∏à‡∏∞‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà ['‡∏ä‡∏≠‡∏ö', '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô', '‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°']
        
        # -----------------------------------------------
        # üß† LOGIC ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏â‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô)
        # -----------------------------------------------
        winner = "‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à" # ‡∏Ñ‡πà‡∏≤ Default
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Keyword (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Ñ‡∏≥‡∏û‡∏ß‡∏Å‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô keywords ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà)
        if any(w in keywords for w in ['‡πÇ‡∏Ñ‡πâ‡∏î', '‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°', '‡∏Ñ‡∏≠‡∏°', '‡πÄ‡∏Å‡∏°', 'robot', 'python', 'java']):
            winner = "‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®"
        elif any(w in keywords for w in ['‡∏ß‡∏≤‡∏î', '‡∏®‡∏¥‡∏•‡∏õ‡∏∞', '‡∏≠‡∏≠‡∏Å‡πÄ‡πÄ‡∏ö‡∏ö', '‡∏™‡∏µ', '‡∏£‡∏π‡∏õ']):
            winner = "‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡∏Å‡∏£‡∏£‡∏°"
        elif any(w in keywords for w in ['‡∏û‡∏π‡∏î', '‡∏ñ‡πà‡∏≤‡∏¢', '‡∏ï‡∏±‡∏î‡∏ï‡πà‡∏≠', '‡πÅ‡∏™‡∏î‡∏á', '‡∏™‡∏∑‡πà‡∏≠']):
            winner = "‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå"
        elif any(w in keywords for w in ['‡∏Ç‡∏≤‡∏¢', '‡πÄ‡∏á‡∏¥‡∏ô', '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', '‡∏´‡∏∏‡πâ‡∏ô', '‡∏ï‡∏•‡∏≤‡∏î']):
            winner = "‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à"
        elif any(w in keywords for w in ['‡πÑ‡∏ü', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏•', '‡∏ã‡πà‡∏≠‡∏°', '‡∏™‡∏£‡πâ‡∏≤‡∏á', '‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô']):
            winner = "‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå"
            
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≥‡∏•‡∏≠‡∏á (Mockup Result)
        result = {
            "winner": winner,
            "runner_up": "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...", # ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÉ‡∏ä‡πâ Logic ‡∏´‡∏≤‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 2 ‡πÑ‡∏î‡πâ
            "courses": [
                {"name": f"‡∏ß‡∏¥‡∏ä‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô{winner}", "match": 90},
                {"name": f"‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå{winner}", "match": 85},
                {"name": "‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£", "match": 80}
            ]
        }
        
        return jsonify(result)

    except Exception as e:
        print(f"Error: {e}")
        return jsonify({"error": str(e)}), 500

if __name__ == '__main__':
    # ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (Render/Vercel ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏≠‡∏µ‡∏Å‡πÅ‡∏ö‡∏ö)
    app.run(host='0.0.0.0', port=5000, debug=True)